<html>
  <body>
    <img id="live" />
    <img id="source" />
    <button onclick="refresh()">Refresh</button>
    <button onclick="stop()">Stop</button>
    <div id="def"></div>
    <script>
      let isRunning = false

      const $live = document.getElementById('live')
      const $source = document.getElementById('source')
      const $def = document.getElementById('def')

      async function start() {
        const response = await fetch('api/start?width=500&height=500', {
          method: 'GET',
        })
        window.requestAnimationFrame(() => render())

        updateImage('api/source', $source)
        // isRunning = true
      }

      async function stop() {
        await fetch('/api/stop')
        isRunning = false
        console.log('Stopped')
      }

      async function updateImage(url, ref) {
        const response = await fetch(url)
        const pixels = await response.text()
        if (pixels) {
          ref.src = pixels
        }
        if (isRunning) window.requestAnimationFrame(updateImage)
      }

      async function updateDef(url, ref) {
        const response = await fetch(url)
        const def = await response.text()
        if (def) {
          ref.innerHTML = def
        }
      }

      function refresh() {
        updateImage('api/render', $live)
        updateDef('api/def', $def)
      }
      start()
    </script>
  </body>
</html>
